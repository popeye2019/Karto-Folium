{% extends "base.html" %}
{% block title %}ðŸ”‘ Modifier mon mot de passe{% endblock %}
{% block content %}
<h2>ðŸ”‘ Modifier mon mot de passe</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" id="change-password-form" novalidate>
  <p>Utilisateur : <strong>{{ user.prenom }} {{ user.nom }}</strong></p>

  <div class="field">
    <label for="current_password">Mot de passe actuel</label>
    <input type="password" id="current_password" name="current_password" required autocomplete="current-password">
  </div>

  <div class="field">
    <label for="new_password">Nouveau mot de passe</label>
    <input type="password" id="new_password" name="new_password" required autocomplete="new-password">
  </div>

  <div class="field">
    <label for="confirm_password">Confirmer le nouveau mot de passe</label>
    <input type="password" id="confirm_password" name="confirm_password" required autocomplete="new-password">
  </div>

  <div id="mismatch-message" class="help" style="display:none; color:#c0392b;">
    Les nouveaux mots de passe ne correspondent pas.
  </div>

  <button type="submit" id="submit-button" class="btn primary btn-icon" disabled>ðŸ’¾ Mettre Ã  jour</button>
</form>

<style>
  #change-password-form {
    max-width: 420px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #change-password-form .field {
    display: flex;
    flex-direction: column;
  }

  #change-password-form label {
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  #change-password-form input {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #555;
    background: #1a242f;
    color: #fff;
  }

  .flash-messages {
    margin-bottom: 1.5rem;
  }

  .flash {
    padding: 0.6rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  .flash.success {
    background: #1f6f43;
  }

  .flash.danger {
    background: #7f1d1d;
  }

  .flash.warning {
    background: #7f5300;
  }

  #submit-button {
    padding: 0.6rem 1.2rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #0c151c;
    color: #fff;
    font-weight: 600;
  }
  #submit-button { display: inline-flex; align-items: center; gap: 0.4rem; }
  #submit-button::before { content: "ðŸ’¾"; }

  #submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<script>
(function() {
  const currentPassword = document.getElementById('current_password');
  const newPassword = document.getElementById('new_password');
  const confirmPassword = document.getElementById('confirm_password');
  const submitButton = document.getElementById('submit-button');
  const mismatchMessage = document.getElementById('mismatch-message');

  function updateState() {
    const currentValue = currentPassword.value.trim();
    const newValue = newPassword.value.trim();
    const confirmValue = confirmPassword.value.trim();

    const hasBothNew = newValue !== '' && confirmValue !== '';
    const passwordsMatch = hasBothNew && newValue === confirmValue;

    mismatchMessage.style.display = passwordsMatch || (!hasBothNew) ? 'none' : 'block';
    submitButton.disabled = !(passwordsMatch && currentValue !== '');
  }

  [currentPassword, newPassword, confirmPassword].forEach((field) => {
    field.addEventListener('input', updateState);
  });

  updateState();
})();
</script>
{% endblock %}


