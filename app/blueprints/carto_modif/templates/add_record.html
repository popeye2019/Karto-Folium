{% extends "base.html" %}
{% block title %}Ajouter un site{% endblock %}
{% block content %}
<section class="page-section">
  <h2>Ajouter un site</h2>
  <form method="post" class="form-panel">
    <div class="field">
      <label>INDEX</label>
      <input type="text" value="{{ record.INDEX }}" readonly>
      <input type="hidden" name="INDEX" value="{{ record.INDEX }}">
    </div>

    <div class="field">
      <label>COMMUNE *</label>
      <select name="COMMUNE" required>
        <option value="">- choisir -</option>
        {% for c in communes %}
          <option value="{{ c }}" {% if record.get('COMMUNE')==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>NOM *</label>
      <input type="text" name="NOM" value="{{ record.get('NOM','') }}" required>
    </div>

    <div class="field">
      <label>TYPE *</label>
      <select name="TYPE" required>
        <option value="">- choisir -</option>
        {% for t in site_types %}
          <option value="{{ t }}" {% if record.get('TYPE')==t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>TECHNOLOGIE</label>
      <input type="text" name="TECHNOLOGIE" value="{{ record.get('TECHNOLOGIE','') }}">
    </div>

    <div class="field">
      <label>ETAT *</label>
      {% set selected_state = record.get('ETAT', site_states[0]) %}
      <select name="ETAT" required>
        {% for state in site_states %}
          <option value="{{ state }}" {% if selected_state == state %}selected{% endif %}>{{ state }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>Latitude (LAT) *</label>
      <input id="LAT" name="LAT" value="{{ record.get('LAT','') }}" required>
    </div>

    <div class="field">
      <label>Longitude (LONG) *</label>
      <input id="LONG" name="LONG" value="{{ record.get('LONG','') }}" required>
    </div>

    <div class="actions">
      <button type="submit">Enregistrer</button>
      <a class="secondary" href="{{ url_for('edit_sites.list_records') }}">Annuler</a>
    </div>
  </form>

  <div class="map-panel">
    <h3>Carte</h3>
    <iframe
      src="{{ url_for('edit_map.get_map', lat=lat0, lon=lon0) }}"
      width="100%" height="520" style="border:1px solid #ccc;border-radius:4px;">
    </iframe>
    <p class="hint">Double-clic sur la carte, puis "Valider" pour remplir LAT/LONG.</p>
  </div>
</section>

<style>
  .page-section {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 2rem;
    max-width: 1100px;
    margin: 2rem auto;
    padding: 1.5rem;
    background: #1a242f;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  }

  .form-panel {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .field input,
  .field select,
  .field textarea {
    padding: 0.55rem 0.65rem;
    border-radius: 6px;
    border: 1px solid #526980;
    background: #101820;
    color: #fff;
  }

  .actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 0.5rem;
  }

  .actions button {
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    border: none;
    background: #0c151c;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }

  .actions button:hover {
    background: #15212c;
  }

  .actions .secondary {
    color: #9fb3c8;
    text-decoration: none;
  }

  .actions .secondary:hover {
    text-decoration: underline;
  }

  .map-panel iframe {
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .hint {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #b0c4d4;
  }
</style>

<script>
  function updateCoordinates(lat, lon){
    document.getElementById('LAT').value  = Number(lat).toFixed(14);
    document.getElementById('LONG').value = Number(lon).toFixed(14);
  }
</script>
{% endblock %}
