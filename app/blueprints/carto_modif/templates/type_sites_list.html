
{% extends "base.html" %}
{% block title %}Types de sites{% endblock %}
{% block content %}
<section class="page-section type-sites">
  <header class="section-header">
    <div>
      <h2>Types de sites</h2>
      <p class="subtitle">Personnalisez ic√¥nes, groupes et options d'affichage pour chaque type d'ouvrage.</p>
    </div>
    <div class="header-actions">
      <a class="button primary btn btn-icon" href="{{ url_for('type_sites.add_type_site') }}">‚ûï Nouveau type</a>
      <form class="icon-upload" action="{{ url_for('type_sites.upload_type_icon') }}" method="post" enctype="multipart/form-data">
        <label class="file-picker">
          <span>Ajouter une ic√¥ne (PNG/JPG)</span>
          <input type="file" name="icon_file" accept=".png,.jpg,.jpeg" required>
        </label>
        <button type="submit" class="btn">T√©l√©verser</button>
      </form>
    </div>
  </header>

  {% if types %}
    <div class="type-grid">
      {% for type_entry in types %}
        {% set idx = loop.index0 %}
        {% set type_label = type_entry.get('type', '') %}
        {% set icon_name = type_entry.get('icon', '') %}
        {% set usage = usage_counters.get(type_label, 0) %}
        <article class="type-card">
          <div class="type-card__icon">
            {% if icon_name %}
              <img src="{{ url_for('type_sites.type_icon', filename=icon_name) }}" alt="Ic√¥ne {{ type_label }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <span class="icon-fallback">{{ icon_name }}</span>
            {% else %}
              <span class="icon-fallback show">(pas d'ic√¥ne)</span>
            {% endif %}
          </div>

          <div class="type-card__body">
            <h3>{{ type_label }}</h3>
            <p class="group">{{ type_entry.get('group', 'Sans groupe') }}</p>

            <ul class="meta">
              <li><strong>√âchelle :</strong> {{ '%.2f'|format(type_entry.get('scale', 1) or 1) }}</li>
              <li><strong>Utilisations :</strong> {{ usage }}</li>
            </ul>

            <div class="badges">
              <span class="badge {{ 'on' if type_entry.get('enabled', True) else 'off' }}">{{ 'Activ√©' if type_entry.get('enabled', True) else 'D√©sactiv√©' }}</span>
              <span class="badge {{ 'on' if type_entry.get('cluster', False) else 'off' }}">{{ 'Cluster' if type_entry.get('cluster', False) else 'Pas de cluster' }}</span>
              <span class="badge {{ 'on' if type_entry.get('show', True) else 'off' }}">{{ 'Visible' if type_entry.get('show', True) else 'Masqu√©' }}</span>
            </div>
          </div>

          <footer class="type-card__footer">
            <a class="link btn secondary btn-icon" href="{{ url_for('type_sites.edit_type_site', type_index=idx) }}">‚úèÔ∏è Modifier</a>
            {% if usage == 0 %}
              <a class="link btn danger btn-icon" href="{{ url_for('type_sites.delete_type_site', type_index=idx) }}">üóëÔ∏è Supprimer</a>
            {% else %}
              <span class="link disabled" title="Ce type est utilis√© {{ usage }} fois">Supprimer</span>
            {% endif %}
          </footer>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="empty">Aucun type enregistr√© pour le moment.</p>
  {% endif %}
</section>

<style>
  .type-sites { max-width: 1200px; margin: 2rem auto; background: #101b25; padding: 2rem; border-radius: 14px; box-shadow: 0 16px 40px rgba(0,0,0,0.35); }
  .section-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem; margin-bottom: 1.5rem; }
  .header-actions { display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap; }
  .icon-upload { display: inline-flex; align-items: center; gap: 0.6rem; background: #0f1a26; padding: 0.55rem 0.9rem; border-radius: 8px; border: 1px solid #1f2d3c; }
  .icon-upload .file-picker { position: relative; overflow: hidden; display: inline-flex; align-items: center; gap: 0.5rem; color: #d4e2f5; cursor: pointer; }
  .icon-upload .file-picker span { pointer-events: none; font-size: 0.9rem; }
  .icon-upload .file-picker input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .icon-upload .btn { background: #1b6ef3; border: none; color: #fff; padding: 0.55rem 1.1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
  .icon-upload .btn { display: inline-flex; align-items: center; gap: 0.4rem; }
  .icon-upload .btn::before { content: "‚¨ÜÔ∏è"; }
  .icon-upload .btn:hover { background: #2c7fff; }

  .section-header h2 { margin: 0; font-size: 1.6rem; }
  .section-header .subtitle { margin: 0.2rem 0 0; color: #9fb3c8; font-size: 0.95rem; }
  .button.primary { background: #0c8dea; color: #fff; padding: 0.65rem 1.4rem; border-radius: 8px; text-decoration: none; font-weight: 600; }
  .button.primary { display: inline-flex; align-items: center; gap: 0.4rem; }
  .button.primary:hover { background: #19a0ff; }
  .type-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
  .type-card { background: #172533; border-radius: 12px; padding: 1.2rem; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 12px 30px rgba(0,0,0,0.25); position: relative; overflow: hidden; }
  .type-card__icon { height: 120px; display: flex; align-items: center; justify-content: center; background: #0f1a26; border-radius: 10px; position: relative; }
  .type-card__icon img { max-height: 100%; max-width: 100%; object-fit: contain; }
  .type-card__icon .icon-fallback { display: none; font-size: 0.85rem; color: #9fb3c8; text-align: center; padding: 0 1rem; }
  .type-card__icon .icon-fallback.show { display: flex; align-items: center; justify-content: center; }
  .type-card__icon img + .icon-fallback { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; }
  .type-card__body h3 { margin: 0; font-size: 1.2rem; }
  .type-card__body .group { margin: 0.4rem 0 0; color: #9fb3c8; font-size: 0.9rem; }
  .type-card__body .meta { list-style: none; padding: 0; margin: 0.8rem 0 0; display: grid; gap: 0.2rem; color: #b9cadb; font-size: 0.9rem; }
  .badges { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.8rem; }
  .badge { padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; background: #243442; color: #c9d6e2; }
  .badge.on { background: #0f5132; color: #c9f5df; }
  .badge.off { background: #522; color: #f2c5c5; }
  .type-card__footer { display: flex; gap: 1rem; margin-top: auto; padding-top: 1rem; border-top: 1px solid #223142; }
  .link { color: #4da3ff; text-decoration: none; font-weight: 600; }
  .type-card__footer .link { display: inline-flex; align-items: center; gap: 0.4rem; }
  .type-card__footer .link.danger::before { content: "üóëÔ∏è"; }
  .type-card__footer .link.disabled::before { content: "üóëÔ∏è"; }
  .link:hover { text-decoration: underline; }
  .link.danger { color: #ff7676; }
  .link.disabled { color: #6b7a8a; cursor: not-allowed; text-decoration: none; }
  .empty { text-align: center; color: #bacadd; }
  @media (max-width: 768px) {
    .section-header { flex-direction: column; align-items: stretch; }
    .type-card__icon { height: 90px; }
  }
</style>
{% endblock %}
