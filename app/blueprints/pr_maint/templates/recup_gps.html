<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Localiser un poste</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f1a26; color: #f2f7ff; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
    .card { background: #172533; padding: 2rem 2.5rem; border-radius: 14px; box-shadow: 0 18px 42px rgba(0,0,0,0.35); max-width: 420px; text-align: center; }
    h1 { margin-top: 0; font-size: 1.5rem; }
    button { margin-top: 1.2rem; padding: 0.75rem 1.8rem; border-radius: 8px; border: none; background: #1b6ef3; color: #fff; font-weight: 600; cursor: pointer; font-size: 1rem; }
    button:hover { background: #2c7fff; }
    button:disabled { background: #324d72; cursor: not-allowed; }
    p.status { margin-top: 1rem; font-size: 0.95rem; color: #c7d9f1; }
    .error { color: #ff8c8c; }
    .hint { font-size: 0.85rem; color: #a9bbcf; margin-top: 0.8rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Localiser un poste</h1>
    <p>Cliquez sur le bouton ci-dessous pour utiliser la localisation de votre appareil et lancer automatiquement la recherche du poste le plus proche.</p>
    <button id="locateBtn" type="button">Localiser</button>
    <p id="status" class="status"></p>
    <p class="hint">La page redirigera vers <code>recherche.php</code> avec vos coordonnées GPS et la zone éventuellement fournie dans l'URL.</p>
  </div>

  <script>
    const btn = document.getElementById('locateBtn');
    const statusEl = document.getElementById('status');

    function updateStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
    }

    // Proactive check: many mobile browsers require HTTPS for geoloc
    // Make it obvious to the user if we are not in a secure context.
    (function preflightChecks() {
      try {
        if (!window.isSecureContext) {
          updateStatus(
            "La géolocalisation nécessite un contexte sécurisé (HTTPS). Accédez au site en HTTPS (ou via un tunnel type ngrok) pour autoriser la localisation.",
            true
          );
        }
      } catch (e) {
        // no-op; best effort
      }
    })();

    function redirectWithPosition(latitude, longitude) {
      const params = new URLSearchParams(window.location.search);
      const zone = params.get('zone') || '';
      const target = new URL('{{ url_for('pr_maint.search_post') }}', window.location.origin);
      target.searchParams.set('latitude', latitude);
      target.searchParams.set('longitude', longitude);
      if (zone) {
        target.searchParams.set('zone', zone);
      }
      window.location.href = target.toString();
    }

    function handleSuccess(position) {
      const { latitude, longitude } = position.coords;
      updateStatus(`Position détectée : ${latitude.toFixed(5)}, ${longitude.toFixed(5)}. Redirection…`);
      redirectWithPosition(latitude, longitude);
    }

    function handleError(error) {
      let message = "Impossible d'obtenir la position.";
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = "Accès à la localisation refusé par l'utilisateur.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Les informations de localisation sont indisponibles.";
          break;
        case error.TIMEOUT:
          message = "La demande de localisation a expiré.";
          break;
        default:
          message = error.message || message;
      }
      updateStatus(message, true);
      btn.disabled = false;
    }

    btn.addEventListener('click', () => {
      try {
        if (!navigator.geolocation) {
          updateStatus("La géolocalisation n'est pas prise en charge par ce navigateur.", true);
          return;
        }
        if (!window.isSecureContext) {
          updateStatus("Contexte non sécurisé (HTTP). La géolocalisation est bloquée sur mobile. Utilisez HTTPS.", true);
          return;
        }
        btn.disabled = true;
        updateStatus("Détection de la position en cours…");
        navigator.geolocation.getCurrentPosition(handleSuccess, handleError, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0,
        });
      } catch (err) {
        console.error('Erreur lors de la demande de géolocalisation:', err);
        updateStatus("Erreur inattendue lors de la demande de géolocalisation.", true);
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
